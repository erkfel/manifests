launch:
    parameters:
        - instnaceSize:
            description: Instnace size
            default: "m1.medium"
            enum:
                "m1.medium": "m1.medium"
                "m1.large": "m1.large"
    steps:
        - node-provision:
            action: compute.grow
            parameters:
                ec2SecurityGroup: atg
                hardwareId: ${instnaceSize}
            output:
                host: ips
        - artifacts-download:
               action: install
               phase: "download"
               parameters:
                    runList: ["recipe[atg::artifacts]"]
        - node-init: &nodeInit
               action: install
               phase: "init"
               precedingPhases: ["download"]
               parameters:
                    runList: ["recipe[atg::init]"]
        - mysql-install: &mysqlInstall
               action: install
               phase: "mysql"
               precedingPhases: ["init"]
               parameters:
                    runList: ["recipe[atg::mysql]"]
        - java-install: &javaInstall
               action: install
               phase: "java"
               precedingPhases: ["mysql"]
               parameters:
                    runList: ["recipe[atg::java]"]
        - jboss-install: &jbossInstall
               action: install
               phase: "jboss"
               precedingPhases: ["java"]
               parameters:
                    runList: ["recipe[atg::jboss]"]
        - tomcat-install: &tomcatInstall
               action: install
               phase: "tomcat"
               precedingPhases: ["jboss"]
               parameters:
                    runList: ["recipe[atg::tomcat]"]
        - profile-setup: &profileSetup
               action: install
               phase: "profile"
               precedingPhases: ["tomcat"]
               parameters:
                    runList: ["recipe[atg::profile]"]
        - atg-core-install: &atgCoreInstall
               action: install
               phase: "atg-core"
               precedingPhases: ["profile"]
               parameters:
                    runList: ["recipe[atg::atg-core]"]
        - atg-crs-install: &atgCrsInstall
               action: install
               phase: "atg-crs"
               precedingPhases: ["atg-core"]
               parameters:
                    runList: ["recipe[atg::atg-crs]"]
        - atg-cim-configuration: &atgCimConfiguration
               action: install
               phase: "atg-cim"
               precedingPhases: ["atg-crs"]
               parameters:
                    runList: ["recipe[atg::atg-cim-tomcat-no-cie]"]
        - iptables-configuration: &iptablesConfiguration
               action: install
               phase: "iptables"
               precedingPhases: ["atg-cim"]
               parameters:
                    runList: ["recipe[atg::iptables]"]
        - tomcat-startup: &tomcatStartup
               action: install
               phase: "tomcat-startup"
               precedingPhases: ["iptables"]
               parameters:
                    runList: ["recipe[atg::post-tomcat]"]
    return:
            reference-store:
                description: ATG Commerce Reference Store
                value: http://${host}:8080/crs
            controll-center:
                description: ATG Business Control Center
                value: http://${host}:8180/atg/bcc

reinstall:
    steps:
        - node-init: *nodeInit
        - mysql-install: *mysqlInstall
        - tomcat-stop:
               action: install
               phase: "stop-tomcat"
               precedingPhases: ["mysql"]
               parameters:
                    runList: ["recipe[atg::stop-tomcat]"]
        - cleanup-jboss:
               action: install
               phase: "cleanup-jboss"
               precedingPhases: ["stop-tomcat"]
               parameters:
                    runList: ["recipe[atg::cleanup-jboss]"]
        - cleanup-tomcat:
               action: install
               phase: "cleanup-tomcat"
               precedingPhases: ["cleanup-jboss"]
               parameters:
                    runList: ["recipe[atg::cleanup-tomcat]"]
        - cleanup:
               action: install
               phase: "cleanup"
               precedingPhases: ["cleanup-tomcat"]
               parameters:
                    runList: ["recipe[atg::cleanup]"]
        - jboss-install:
               action: install
               phase: "java"
               precedingPhases: ["cleanup"]
               parameters:
                    runList: ["recipe[atg::java]"]
        - jboss-install: *jbossInstall
        - tomcat-install: *tomcatInstall
        - profile-setup: *profileSetup
        - atg-core-install: *atgCoreInstall
        - atg-crs-install: *atgCrsInstall
        - atg-cim-configuration: *atgCimConfiguration
        - iptables-configuration: *iptablesConfiguration
        - tomcat-startup: *tomcatStartup

destroy:
    steps:
        - destroy-vm:
            action: undeployEnv
            phase: destroy
