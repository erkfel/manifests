launch:
    parameters:
        - repository-url:
            description: Artifact repository URL
            default: http://172.18.130.72
        - artifact-url:
            description: CRS Aftifact name
            default: http://black.calf.lupus.griddynamics.net:8081/nexus/content/repositories/atg/atg/commerce-reference-store/10.1/commerce-reference-store-10.1.zip
    steps:
        - provision:
            action: compute.grow
            output:
                host: privateips
        - fqdn:
            action: execrun
            parameters:
                phase: fqdn
                roles: ["defaultRole"]
                precedingPhases: ["provision"]
                command:
                  - "sed"
                  - "-i"
                  - "/127.0.0.1/s/127.0.0.1[ ]*localhost /127.0.0.1 vcloud-test.local localhost /"
                  - "/etc/hosts"
        - hostname:
            action: execrun
            parameters:
                phase: hostname
                roles: ["defaultRole"]
                precedingPhases: ["fqdn"]
                command:
                  - "echo vcloud-test.local > /proc/sys/kernel/hostname"
        - wget:
            action: execrun
            parameters:
                phase: wget
                roles: ["defaultRole"]
                precedingPhases: ["hostname"]
                command:
                  - "yum"
                  - "-y"
                  - "install"
                  - "wget"
        - node-init: &nodeInit
               action: install
               parameters:
                    phase: "init"
                    precedingPhases: ["wget"]
                    runList: ["recipe[atg::artifacts]", "recipe[atg::init]", "recipe[atg::mysql]", "recipe[atg::java]", "recipe[atg::jboss]", "recipe[atg::tomcat]", "recipe[atg::profile]"]
                    jattrs:
                        repository-url: ${repository-url}
                        artifact-url: ${artifact-url}
        - atg-install: &atgCoreInstall
               action: install
               parameters:
                    phase: "atg-install"
                    precedingPhases: ["init"]
                    runList: ["recipe[atg::atg-core]", "recipe[atg::atg-deploy-crs]", "recipe[atg::atg-cim-tomcat-no-cie]"]
        - tomcat-startup: &tomcatStartup
               action: install
               parameters:
                    phase: "tomcat-startup"
                    precedingPhases: ["atg-install"]
                    runList: ["recipe[atg::iptables]", "recipe[atg::post-tomcat]"]
    return:
            host-ip:
                description: ATG Host IP adress
                value: ${host}
            reference-store:
                description: ATG Commerce Reference Store
                value: http://${host}:8080/crs
            controll-center:
                description: ATG Business Control Center
                value: http://${host}:8180/atg/bcc
destroy:
    steps:
        - undeployEnv:
            action: "undeployEnv"
            parameters:
              phase: "destroy"